name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/zabala-gailetak

jobs:
  pre-deployment-checks:
    name: Pre-Deployment Checks
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Check deployment conditions
        id: check
        run: |
          echo "should_deploy=true" >> $GITHUB_OUTPUT

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks]
    if: |
      needs.pre-deployment-checks.outputs.should_deploy == 'true' &&
      (github.event.inputs.environment == 'staging' || github.event.inputs.environment == '')
    environment:
      name: staging
      url: https://staging.zabala-gailetak.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1
      
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USERNAME }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: 22
          script: |
            cd /opt/zabala-gailetak
            
            git pull origin main
            
            docker-compose -f docker-compose.hrportal.yml pull
            
            docker-compose -f docker-compose.hrportal.yml down
            
            docker-compose -f docker-compose.hrportal.yml up -d
            
            sleep 30
            
            # Use native migrate script
            docker-compose -f docker-compose.hrportal.yml exec -T php ./scripts/migrate.sh
            
            curl -f http://localhost:8080/api/health || exit 1
      
      - name: Run smoke tests
        run: |
          npm install -g newman
          newman run tests/postman/smoke-tests.json \
            --environment tests/postman/staging-env.json

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, deploy-staging]
    if: |
      needs.pre-deployment-checks.outputs.should_deploy == 'true' &&
      github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://zabala-gailetak.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Create deployment backup
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/zabala-gailetak
            
            docker-compose -f docker-compose.hrportal.yml exec -T postgres pg_dump -U user hr_portal \
              > /backups/pre-deployment-$(date +%Y%m%d-%H%M%S).sql
            
            tar -czf /backups/app-state-$(date +%Y%m%d-%H%M%S).tar.gz .
      
      - name: Deploy to production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USERNAME }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/zabala-gailetak
            
            git pull origin main
            
            docker-compose -f docker-compose.hrportal.yml pull
            
            docker-compose -f docker-compose.hrportal.yml up -d
            
            sleep 30
            
            curl -f http://localhost:8080/api/health || exit 1
            
            # Native migration
            docker-compose -f docker-compose.hrportal.yml exec -T php ./scripts/migrate.sh
      
      - name: Verify deployment
        run: |
          curl -f https://zabala-gailetak.com/api/health || exit 1
      
      - name: Run smoke tests
        run: |
          npm install -g newman
          newman run tests/postman/smoke-tests.json \
            --environment tests/postman/production-env.json